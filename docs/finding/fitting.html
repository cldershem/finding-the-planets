<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Fitting - Finding the Planets</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A book accompanying a workshop to find the planets around Trappist-1.">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        
        <!-- MathJax -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

        <!-- Custom JS script -->
        

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li class="affix"><a href="./about.html">What is this book about</a></li><li><a href="./background.html"><strong>1.</strong> Background</a></li><li><ul class="section"><li><a href="./background/trappist-1.html"><strong>1.1.</strong> Trappist-1</a></li><li><a href="./background/kepler.html"><strong>1.2.</strong> Kepler Spacecraft</a></li></ul></li><li><a href="./science.html"><strong>2.</strong> Science</a></li><li><ul class="section"><li><a href="./science/discovery.html"><strong>2.1.</strong> Exo-planet Discovery</a></li><li><a href="./science/position.html"><strong>2.2.</strong> Observing Position</a></li><li><a href="./science/doppler.html"><strong>2.3.</strong> Doppler Effect</a></li></ul></li><li><a href="./transit.html"><strong>3.</strong> Transit Method</a></li><li><ul class="section"><li><a href="./transit/light_curve.html"><strong>3.1.</strong> What To Look For</a></li></ul></li><li><a href="./finding.html"><strong>4.</strong> Finding Planets</a></li><li><ul class="section"><li><a href="./finding/fits.html"><strong>4.1.</strong> FITS</a></li><li><a href="./finding/csv.html"><strong>4.2.</strong> CSV</a></li><li><a href="./finding/image.html"><strong>4.3.</strong> Image</a></li><li><a href="./finding/collage.html"><strong>4.4.</strong> Collage</a></li><li><a href="./finding/brightness.html"><strong>4.5.</strong> Brightness</a></li><li><a href="./finding/detrend.html"><strong>4.6.</strong> Detrend</a></li><li><a href="./finding/filter.html"><strong>4.7.</strong> Filter</a></li><li><a href="./finding/median.html"><strong>4.8.</strong> Median</a></li><li><a href="./finding/fitting.html" class="active"><strong>4.9.</strong> Fitting</a></li></ul></li><li><a href="./setup.html">Setup</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title">Finding the Planets</h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="fitting.html#fitting" id="fitting"><h1>Fitting</h1></a>
<p>We have created a plot of the median.</p>
<p><img src="image/median.png" alt="The median of the filtered brightness" /></p>
<p>We would like to find planets in it. Finding planets amounts to selecting a
transit curve that nicely fits our data. We our going to divide that task in the
following sub-tasks.</p>
<ol>
<li>Generating a transit curve series</li>
<li>Iterating over all transit curve parameters</li>
<li>Scoring each candidate transit curve and selecting the best</li>
</ol>
<p>Let us create a module for this as well. We will call it <code>fit</code>.</p>
<a class="header" href="fitting.html#transit curves" id="transit curves"><h2>Transit Curves</h2></a>
<a class="header" href="fitting.html#iterate parameters" id="iterate parameters"><h2>Iterate Parameters</h2></a>
<p>Our transit curve has five parameters. We would like to generate candidate
transit curves and check how well they fit our data. This can be accomplished by
iterating over the five parameters, and mapping them into a transit curve.</p>
<a class="header" href="fitting.html#floatiterator" id="floatiterator"><h3>FloatIterator</h3></a>
<p>We will first focus on an iterator for a single <code>f64</code>. We want all floating
point numbers between a <code>start</code> and <code>finish</code>, increasing each new number with a
certain <code>step</code>. We will create a <code>struct</code> that keeps track of where we are.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub struct FloatIterator {
    start: f64,
    finish: f64,
    step: f64,
    current: u64,
}
#}</code></pre></pre>
<p>Implementing a <code>new</code> constructor should set the <code>current</code> to <code>0</code> and accept
<code>start</code>, <code>finish</code> and step as parameters.</p>
<p>Next we need to implement <code>Iterator</code> for <code>FloatIterator</code>. We must import
<code>std::iter::Iterator</code> so that we can easily reference it in our code. In the
<code>next</code> method of the <code>Iterator</code> trait we need to decide if we need to return a
<code>Some</code> or a <code>None</code>. This depends on the our intended return value. I.e. if the
value <code>start + step * current</code> is less then or equal to our <code>finish</code>.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
impl Iterator for FloatIterator {
    type Item = f64;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        let value = self.start + self.step * (self.current as f64);

        if value &lt;= self.finish {
            self.current += 1;

            Some(value)
        } else {
            None
        }
    }
}
#}</code></pre></pre>
<p>This wraps up our <code>FloatIterator</code>.</p>
<a class="header" href="fitting.html#exemplar tupleiterator" id="exemplar tupleiterator"><h3>Exemplar TupleIterator</h3></a>
<p>Next we are going to create a <code>TupleIterator</code>. It is going to show all the
necessary tools to create the actual <code>TupleIterator</code> we want, without getting
distracted by the tedious details.</p>
<p>Because we want to express multiple times a range of floating point numbers we
are interested in, we are going to create a <code>struct</code> to keep track of <code>start</code>,
<code>finish</code> and <code>step</code>.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub struct FloatRange {
    start: f64,
    finish: f64,
    step: f64,
}
#}</code></pre></pre>
<p>implementing a <code>new</code> constructor for <code>FloatRange</code> is nothing more than excepting
the correct parameters and passing them in the struct. Having a <code>FloatRange</code>
allows us to ask it for the value belonging to a certain index. Let's extend the
implementation of <code>FloatRange</code> with an <code>index</code> function. The actual
implementation looks very familiar.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
fn index(&amp;self, index: u64) -&gt; Option&lt;f64&gt; {
    let value = self.start + self.step * (index as f64);

    if value &lt;= self.finish {
        Some(value)
    } else {
        None
    }
}
#}</code></pre></pre>
<p>Now that we can express the floating point range we are interested in, we can
use that in our <code>TupleIterator</code>. The responsibility of the <code>TupleIterator</code> is to
keep track of two indices into two separate <code>FloatIterator</code>. Because we need to
be able to &quot;restart&quot; the <code>FloatIterator</code> we are not actually use a
<code>FloatIterator</code>. Instead we choose to do the iterating our selves.</p>
<p>We start with a structure that will keep track for us.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
pub struct TupleIterator {
    first: FloatRange,
    second: FloatRange,
    current: (u64, u64),
}
#}</code></pre></pre>
<p>It looks a lot like the <code>FloatIterator</code>. The main difference is that we need to
keep track of two different ranges, and two different indices into these
iterators. Implementing a new is just like the <code>FloatIterator</code> little more than
accepting the correct parameters and initializing the current indices to
<code>(0,0)</code>.</p>
<p>Now for implementing <code>Iterator</code> for <code>TupleIterator</code>. It comes down to keeping
track of the right indices. Let's look at the implementation.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
impl Iterator for TupleIterator {
    type Item = (f64, f64);

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        let (first_index, second_index) = self.current;

        match self.first.index(first_index) {
            Some(first_value) =&gt; {
                match self.second.index(second_index) {
                    Some(second_value) =&gt; {
                        self.current = (first_index, second_index + 1);

                        Some((first_value, second_value))
                    },

                    None =&gt; {
                        self.current = (first_index + 1, 0);

                        self.next()
                    },
                }
            },

            None =&gt; None,
        }
    }
}
#}</code></pre></pre>
<a class="header" href="fitting.html#score" id="score"><h2>Score</h2></a>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="./finding/median.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="./setup.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./finding/median.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./setup.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
